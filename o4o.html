<title>OAuth for Okta</title>
<style>
body {
    font-family: sans-serif;
    width: 1100px;
    margin: auto;
}
td {
    padding: 1px 8px;
}
</style>
<body>
<h1>OAuth for Okta</h1>
<div id=app>Loading...</div>
<script>
onload = async function () {
    paths = []
    hash = {}

    // Parse OpenAPI spec for paths.
    r = await fetch('https://raw.githubusercontent.com/okta/okta-management-openapi-spec/master/dist/spec.json')
    spec = await r.json()
    for (const [path, methods] of Object.entries(spec.paths)) {
        for (const method of Object.keys(methods)) {
            paths.push({method, path})
            hash[method + path.replace(/\{(.*?)\}/g, '{}')] = true
        }
    }
    version = spec.info.version

    // Search docs for additional paths.
    r = await fetch('https://api.github.com/search/code?q=repo:okta/okta-developer-docs ApiOperation extension:md');
    page = await r.json()
    await Promise.all(page.items.map(async item => {
        r = await fetch('https://raw.githubusercontent.com/okta/okta-developer-docs/master/' + item.path)
        lines = (await r.text()).split('\n')
        lines.forEach(line => {
            if (match = line.match(/ApiOperation method="(.*?)" url="(.*?)"/)) {
                [_, method, path] = match
                method = method.toLowerCase()
                path = path.replace(/\${/g, '{').replace('{baseUrl}', '').replace('https://{yourOktaDomain}', '').trim()
                if (path.startsWith('/v1')) path = '/api' + path
                if (!hash[method + path.replace(/\{(.*?)\}/g, '{}')]) {
                    paths.push({method, path})
                }
            }
        })
    }))

    base = 'https://gsroka-neto.oktapreview.com'
    headers = {Authorization: 'Bearer invalidToken'}

    paths.sort((p1, p2) => (p1.path + p1.method).localeCompare(p2.path + p2.method))

    rows = await Promise.all(paths.map(async ({method, path}) => {
        if (path == '/api/v1/idps/{idpId}/credentials/csrs/{csrId}/lifecycle/publish') {
            headers['content-type'] = 'application/pkix-cert'
        } else {
            headers['content-type'] = 'application/json'
        }
        if (path == '/api/v1/policies?type={type}') {
            path = '/api/v1/policies?type=Okta:SignOn'
        }
        try {
            r = await fetch(base + path, {headers, method})
            scope = r.headers.get('www-authenticate').match(/scope="(.*?)"/)[1]
        } catch (e) {
            scope = ''
        }
        return `<tr><td>${method}<td>${path}<td>${scope}<td>${r.status}`
    }))
    app.innerHTML = `<a href="https://github.com/okta/okta-management-openapi-spec">OpenAPI v. ${version}</a><br><br>` +
        '<table><tr><th>Method<th>Path<th>Scope<th>Status' + rows.join('') + '</table>'
}
</script>
</body>
