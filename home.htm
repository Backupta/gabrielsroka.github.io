<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Apps</title>
<link href="https://ok1static.oktacdn.com/assets/css/enduser/enduser.css" type="text/css" rel="stylesheet" />
<style>
.app-button-wrapper {
    width: 64px;
    margin-left: 32px;
    margin-bottom: 20px;
}
.app-button .logo {
    visibility: visible;
}
.app-button-name {
    width: 100%;
}
</style>
</head>
<body>
<br>
<nav>
<a id="home"><span class="inline-icon icon-home-light"></span><span>Home</span></a> - 
<a id="refresh"><span>Refresh</span></a> - 
<a href="/login.htm?signout">Sign out</a>
<br>
</nav>
<br>
<main>
<div id="app"></div>
</main>
<script>
const baseUrl = "https://gsroka-neto.oktapreview.com";

home.href = baseUrl;
refresh.onclick = getLinks;

if (localStorage.links) {
    var links = JSON.parse(localStorage.links);
    showLinks(links);
} else {
    getLinks();
}

function getLinks() {
    var init = {credentials: "include"}; // For this to work, enable CORS in Okta: Security > API > Trusted Origins > Add Origin > CORS.
    // var init = {mode: "cors"}; // This didn't seem to work.
    fetch(`${baseUrl}/api/v1/users/me/appLinks`, init)
    .then(response => response.json())
    .then(links => {
        var newLinks = [];
        links.sort((link1, link2) => link1.sortOrder < link2.sortOrder ? -1 : 1)
        .forEach(link => {
            var [label, url] = link.label.split(/,/);
            if (url !== undefined) {
                url = url.trim();
                if (url === "") url = label.replace(/ /g, "");
                if (!url.startsWith("https")) url = "https://" + url;
                if (!url.includes(".")) url += ".com";
                newLinks.push({label, url});
            }
        });
        links = newLinks;
        localStorage.links = JSON.stringify(links);
        showLinks(links);
    }).catch(error => location.href = "/login.htm");
}

function showLinks(links) {
    var lis = "";
    links.forEach(link => {
        lis += `<li class='app-button-wrapper'>` +
            `<a href='${link.url}' target='_blank' class='app-button' rel='noopener'>` +
            `<img src='${new URL(link.url).origin}/favicon.ico' class='logo'/></a>` +
            `<p class='app-button-name'>${link.label}`;
    });
    app.innerHTML = `<ul>${lis}</ul>`;
}
</script>
</body>
</html>
