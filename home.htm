<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Example Okta SignIn Widget</title>
  <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
  <![endif]-->
  <script src="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.9.0/js/okta-sign-in.min.js" type="text/javascript"></script>
  <link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.9.0/css/okta-sign-in.min.css" type="text/css" rel="stylesheet">
  <link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.9.0/css/okta-theme.css" type="text/css" rel="stylesheet">
</head>
<body>
  <!-- Render the login widget here -->
  <div id="okta-login-container"></div>

  <!-- Script to init the widget -->
  <script>
  /*
    see:
    http://developer.okta.com/code/javascript/okta_sign-in_widget
    https://github.com/okta/okta-signin-widget
  */
  
    if (location.protocol == "http:") location = location.href.replace(/http/, "https");

    var baseUrl = 'https://gsroka-neto.oktapreview.com';
    var config = {
      baseUrl: baseUrl
    };
    var signIn = new OktaSignIn(config);

    signIn.renderEl(
      { el: '#okta-login-container' },
      function (res) {
        if (res.status === 'SUCCESS') {

        var request = new XMLHttpRequest();
        request.open("GET", "https://gsroka-neto.oktapreview.com/api/v1/users/me/appLinks");
        request.onload = function () {
            var links = JSON.parse(this.responseText.replace(/SAML/g, "").replace(/Okta\.com/g, "").replace(/Okta /g, "").replace(/Gsuite/g, "G Suite").replace(/Atlassian Cloud/g, "").replace(/\.net account/, ""));
            links.sort((link1, link2) => link1.sortOrder < link2.sortOrder ? -1 : 1);
            document.write(`<title>My Apps</title><link href="https://ok3static.oktacdn.com/assets/css/widgets/chosen.a7aa2f61c6950df36987b8273c15a6be.css" type="text/css" rel="stylesheet"/>
                <link href="https://ok3static.oktacdn.com/assets/css/enduser/enduser.be9c75cd7f709dbb05ac1ab439ea9ec4.css" type="text/css" rel="stylesheet"/>
                <link href="https://ok3static.oktacdn.com/assets/css/widgets/jquery.qtip.188d7d3c1fd4644f3496390bc187bd08.css" type="text/css" rel="stylesheet"/>`);
            document.write("<br><ul>");
            links.forEach(link => document.write(`<li class='app-button-wrapper'>
                <a href='${link.linkUrl}' target='_blank' class='app-button'><img src='${link.logoUrl}' style='visibility: visible' class='logo'/></a><p class='app-button-name'>${link.label}`));
            document.write("</ul>");
            document.close();
        };
        request.send();

          //res.session.setCookieAndRedirect(baseUrl);
        } else {
          console.log(res.status);
        }
      },
      function (err) {
        // The widget will handle most types of errors - for example, if the user
        // enters an invalid password or there are issues authenticating.
        //
        // This function is invoked with errors the widget cannot recover from:
        // 1. Known errors: CONFIG_ERROR, UNSUPPORTED_BROWSER_ERROR, OAUTH_ERROR
        // 2. Uncaught exceptions
        console.log(err);
      }
    );
  </script>
</body>
</html>
